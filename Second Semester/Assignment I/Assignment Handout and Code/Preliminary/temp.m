clear
clc
% rng(0)
tic
% Will Delete later
%--------------------------------------------------------------------------
% Caplet prices with strike K=0.05 and maturities T_1 to T_{N-1}
Caplets=[0.022922737518613 0.023535825778635 0.023194289857391 0.022294316394003 0.021086407641792 ...
    0.019728461392470 0.018320943715610 0.016927232296721 0.015586172322853 0.014320233052482 ...
    0.013140971196705 0.012052749925964 0.011055287463489 0.010145403965974 0.009318213062292 ...
    0.008567926766803 0.007888391002214 0.007273433858145 0.006717084341419];
%--------------------------------------------------------------------------
%% Data
%--------------------------------------------------------------------------
% Bond prices for T_0 to T_{N+1}
Bstar=[1.000000000000000 0.931733068514009 0.867336864194859 0.807180507606257 0.751390186399840 ...
    0.699924481765438 0.652631479135652 0.609290924427683 0.569644566898682 0.533417438303370 ...
    0.500332340416184 0.470119346466237 0.442521711052162 0.417299242183633 0.394229917259718 ...
    0.373110314043405 0.353755267713142 0.335997045644106 0.319684243642614 0.304680543400063 ...
    0.290863424934260 0.278122895071373];

% Forward Rates derived from the bond Prices 
fstar = [0.070000000000000 0.071163908099692 0.071749550745182 ...
    0.071750938523962 0.071287420411181 0.070454753142712 ...
    0.069338979002964 0.068001160258291 0.066491256944801 ...
    0.064864780213725 0.063149485640679 0.061384231031525 ...
    0.059591220846755 0.057770455086370 0.055955240441108 ...
    0.054162230256338 0.052391424532061 0.050648374383400 ...
    0.048927528695231 0.047239989697800 0.045596859621355];
alpha = 0.084987000000019;
sigma = 0.025512300000002;
r0 = 0.07;
K = 0.05; 
%--------------------------------------------------------------------------
%% Useful Inline functions
%--------------------------------------------------------------------------
A = @(t1,t2)  (1./alpha).*(1-exp(-alpha.*(t2-t1)));

C = @(t1,t2) log(Bstar(t2+1)./Bstar(t1+1)) ...
    + fstar(t1+1).*A(t1,t2) ...
    - ((sigma.^2)/(4*alpha)).*(1-exp(-2*alpha.*t1)).*A(t1,t2).^2 ;

D = @(t) (sigma^2./(2*alpha.^2)) .* ...
    (  1-exp(-alpha.*t).*(1+alpha.*A(zeros(size(t)),t))  ) ...
    + fstar(t+1) ...
    - r0.*exp(-alpha.*t) ;

sigma_Y = @(t1,t2) sqrt((sigma.^2/alpha.^2) .*...
    ((t2 - t1) - A(t1,t2) - 0.5.*alpha.*A(t1,t2).^2 ));

sigma_r =@(t1,t2) sqrt((sigma.^2/(2*alpha)).*(1-exp(-2*alpha.*(t2-t1))));

sigma_rY = @(t1,t2) (0.5.*sigma.^2).*A(t1,t2).^2;

rho_rY = @(t1,t2) (sigma_rY(t1,t2))./( sigma_r(t1,t2).*sigma_Y(t1,t2) );
mu_r =@(t1,t2,rt1) exp(-alpha.*(t2-t1)).*rt1 + D(t2) ...
    -exp(-alpha.*(t2-t1)).*D(t1);

mu_Y =@(t1,t2,Yt1,rt1) Yt1 + A(t1,t2).*rt1 + ...
    0.5.*sigma_Y(t1,t2).^2 - C(t1,t2);
%--------------------------------------------------------------------------
%% Joint realisations for the short rate and discount factors for time T
%--------------------------------------------------------------------------
for index = 1:19

n = 20000;  
t0 = 0;
t1 = index; 
t2 = t1+1;
Yt0 = t0;
Z = randn(2,n,2);
Z1 = Z(1,:,1);
Z2 = Z(2,:,1);
Z3 = Z(1,:,2);
Z4 = Z(2,:,2);
%--------------------------------------------------------------------------
rt1 = mu_r(t0,t1,r0) + sigma_r(t0,t1).*Z1;
Yt1 = mu_Y(t0,t1,Yt0,r0) + sigma_Y(t0,t1).*...
    (rho_rY(t0,t1).*Z1 + sqrt(1-rho_rY(t0,t1).^2).*Z2 );
Yt2 = mu_Y(t1,t2,Yt1,rt1) + sigma_Y(t1,t2).*...
    (rho_rY(t1,t2).*Z3 + sqrt(1-rho_rY(t1,t2).^2).*Z4 );
Beta_t2 = exp(-Yt2);
Bt1t2 = exp(-A(t1,t2).*rt1 + C(t1,t2));
sample1  = mean(Beta_t2.*max(((1./Bt1t2)-1)-K,0));
%--------------------------------------------------------------------------
rt1 = mu_r(t0,t1,r0) + sigma_r(t0,t1).*-Z1;
Yt1 = mu_Y(t0,t1,Yt0,r0) + sigma_Y(t0,t1).*...
    (rho_rY(t0,t1).*-Z1 + sqrt(1-rho_rY(t0,t1).^2).*-Z2 );
Yt2 = mu_Y(t1,t2,Yt1,rt1) + sigma_Y(t1,t2).*...
    (rho_rY(t1,t2).*-Z3 + sqrt(1-rho_rY(t1,t2).^2).*-Z4 );
Beta_t2 = exp(-Yt2);
Bt1t2 = exp(-A(t1,t2).*rt1 + C(t1,t2));
sample2  = mean(Beta_t2.*max(((1./Bt1t2)-1)-K,0));
%%
%--------------------------------------------------------------------------
%--------------------------------------------------------------------------

mat(index) = PriceCapletControlAnti(index,K); 
 
end 

figure() 
hold on 
plot(mat,'k.') 
plot(Caplets,'b-') 
hold off 












